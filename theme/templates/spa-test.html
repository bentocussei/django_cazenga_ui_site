<!DOCTYPE html>
<html>
<head>
    <title>Teste SPA Simples</title>
    <style>
        body { font-family: sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .links { margin: 20px 0; }
        .links a { display: block; padding: 10px; margin: 5px 0; background: #007cba; color: white; text-decoration: none; border-radius: 5px; }
        .links a:hover { background: #005a87; }
        #content { border: 2px dashed #ccc; padding: 20px; min-height: 200px; }
        .loading { color: orange; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste SPA Ultra-Simples</h1>
        
        <div class="debug">
            <h3>ğŸ“‹ Status:</h3>
            <div id="status">Carregando...</div>
        </div>
        
        <div class="links">
            <h3>ğŸ”— Links de Teste (com SPA):</h3>
            <a href="/components/ui/button/" data-spa-link>Button Component</a>
            <a href="/components/ui/card/" data-spa-link>Card Component</a>
            <a href="/components/ui/" data-spa-link>Components List</a>
        </div>
        
        <div class="links">
            <h3>ğŸ”— Link Normal (sem SPA):</h3>
            <a href="/components/ui/button/">Button Component (navegaÃ§Ã£o normal)</a>
        </div>
        
        <div id="content">
            <h3>ğŸ“„ ConteÃºdo Principal</h3>
            <p>Este conteÃºdo deve mudar quando vocÃª clicar nos links SPA acima, mas permanecer igual para o link normal.</p>
            <p><strong>ID:</strong> <span id="content-id">inicial</span></p>
        </div>
        
        <div class="debug">
            <h3>ğŸ” Log:</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        console.log('ğŸš€ Teste SPA iniciando...');
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'loading' ? 'loading' : '';
            logEl.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        // Sistema SPA Ultra-Simples
        let requestId = 1;
        
        function setupSPA() {
            log('ğŸ”§ Configurando SPA...');
            
            document.addEventListener('click', (e) => {
                const link = e.target.closest('[data-spa-link]');
                if (!link) return;
                
                e.preventDefault();
                log(`ğŸ–±ï¸ Clique interceptado: ${link.href}`, 'loading');
                navigateSPA(link.href);
            });
            
            updateStatus('âœ… SPA Ativo');
            log('âœ… SPA configurado com sucesso!', 'success');
        }
        
        async function navigateSPA(url) {
            const currentRequestId = requestId++;
            
            try {
                updateStatus('ğŸ”„ Carregando...');
                log(`ğŸ“¡ RequisiÃ§Ã£o #${currentRequestId}: ${url}?partial=true`, 'loading');
                
                const response = await fetch(url + '?partial=true', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`ğŸ“¥ Resposta #${currentRequestId}: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                log(`ğŸ“‹ Content-Type: ${contentType}`);
                
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    log(`âœ… JSON recebido! Tamanho: ${JSON.stringify(data).length} chars`, 'success');
                    
                    // Atualizar conteÃºdo
                    const contentEl = document.getElementById('content');
                    if (data.content) {
                        contentEl.innerHTML = data.content;
                        log('ğŸ”„ ConteÃºdo atualizado!', 'success');
                    } else {
                        log('âš ï¸ Resposta JSON nÃ£o contÃ©m "content"', 'error');
                        log(`ğŸ“‹ Dados recebidos: ${JSON.stringify(data)}`);
                    }
                    
                    // Atualizar URL e tÃ­tulo
                    if (data.title) {
                        document.title = data.title;
                    }
                    window.history.pushState({}, data.title || '', url);
                    
                    // Atualizar ID para mostrar que mudou
                    const idEl = document.getElementById('content-id');
                    if (idEl) {
                        idEl.textContent = `spa-${currentRequestId}-${Date.now()}`;
                    }
                    
                    updateStatus('âœ… SPA Funcionando!');
                    log('ğŸ‰ NavegaÃ§Ã£o SPA concluÃ­da!', 'success');
                    
                } else {
                    log('âŒ Resposta nÃ£o Ã© JSON! Provavelmente retornou HTML completo', 'error');
                    log(`ğŸ“‹ Content-Type: ${contentType}`);
                    const text = await response.text();
                    log(`ğŸ“‹ Primeiros 200 chars da resposta: ${text.substring(0, 200)}...`);
                    
                    updateStatus('âŒ Erro: Resposta nÃ£o Ã© JSON');
                    throw new Error('Resposta nÃ£o Ã© JSON - Django nÃ£o estÃ¡ detectando requisiÃ§Ã£o AJAX');
                }
                
            } catch (error) {
                log(`âŒ Erro #${currentRequestId}: ${error.message}`, 'error');
                updateStatus('âŒ Erro SPA');
                
                // Fallback para navegaÃ§Ã£o normal
                log('ğŸ”„ Fallback: navegaÃ§Ã£o normal');
                window.location.href = url;
            }
        }
        
        // Teste direto da view
        async function testBackend() {
            log('ğŸ§ª Testando backend...');
            
            try {
                const response = await fetch('/components/ui/button/?partial=true', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                log(`ğŸ¯ Teste backend - Status: ${response.status}, Content-Type: ${contentType}`);
                
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    log('âœ… Backend retorna JSON corretamente!', 'success');
                    log(`ğŸ“‹ Chaves disponÃ­veis: ${Object.keys(data).join(', ')}`);
                } else {
                    log('âŒ Backend NÃƒO retorna JSON!', 'error');
                    const text = await response.text();
                    log(`ğŸ“‹ Resposta (primeiros 200 chars): ${text.substring(0, 200)}...`);
                }
                
            } catch (error) {
                log(`âŒ Erro no teste backend: ${error.message}`, 'error');
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸŸ¢ DOM carregado');
            setupSPA();
            
            // Testar backend apÃ³s 1 segundo
            setTimeout(testBackend, 1000);
        });
    </script>
</body>
</html> 