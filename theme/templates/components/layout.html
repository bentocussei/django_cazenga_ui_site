<!--
Componente: Layout com suporte SPA
Uso: include "components/layout.html" with layout_type="sidebar-left" header_content="..." main_content="..." 

Parâmetros:
- layout_type: "sidebar-left", "sidebar-right", "header-only", "sidebar-only", "full" (padrão: "sidebar-left")
- sidebar_collapsible: true/false - se sidebar pode ser recolhida (padrão: true)
- sidebar_width: largura da sidebar (padrão: "w-64")
- sidebar_collapsed_width: largura da sidebar recolhida (padrão: "w-16")
- header_height: altura do header (padrão: "h-16")
- footer_height: altura do footer (padrão: "h-16")
- sidebar_content: conteúdo da sidebar (HTML)
- header_content: conteúdo do header (HTML)
- main_content: conteúdo principal (HTML)
- footer_content: conteúdo do footer (HTML)
- class: classes CSS adicionais para o container principal (opcional)
- sidebar_class: classes CSS adicionais para a sidebar (opcional)
- header_class: classes CSS adicionais para o header (opcional)
- main_class: classes CSS adicionais para o main (opcional)
- footer_class: classes CSS adicionais para o footer (opcional)
- spa_enabled: true/false - ativar funcionalidades SPA (padrão: true)
-->

<!-- Set default values -->
{% load static %}
{% if not layout_type %}{% with layout_type="sidebar-left" %}{% endwith %}{% endif %}
{% if not sidebar_collapsible %}{% with sidebar_collapsible=True %}{% endwith %}{% endif %}
{% if not sidebar_width %}{% with sidebar_width="w-64" %}{% endwith %}{% endif %}
{% if not sidebar_collapsed_width %}{% with sidebar_collapsed_width="w-16" %}{% endwith %}{% endif %}
{% if not header_height %}{% with header_height="h-16" %}{% endwith %}{% endif %}
{% if not footer_height %}{% with footer_height="h-16" %}{% endwith %}{% endif %}
{% if spa_enabled == None %}{% with spa_enabled=True %}{% endwith %}{% endif %}

<!-- Progress bar SPA -->
{% if spa_enabled %}
<div id="spa-progress-bar" class="fixed top-0 left-0 right-0 h-1 bg-primary z-50 transition-all duration-300" style="width: 0%; opacity: 0;"></div>
{% endif %}

<div class="{{ class|default:'' }}">
    {% if layout_type == "sidebar-left" or layout_type == "sidebar-right" %}
        <!-- Layout com Sidebar -->
        <div class="flex h-screen" 
            x-data="{ 
                sidebarOpen: window.innerWidth >= 768, 
                sidebarCollapsed: false, 
                isMobile: window.innerWidth < 768,
                spaEnabled: {{ spa_enabled|yesno:'true,false' }}
            }" 
            x-init="
                // Detectar mudanças na largura da janela
                const handleResize = () => {
                    const newIsMobile = window.innerWidth < 768;
                    if (newIsMobile !== isMobile) {
                        isMobile = newIsMobile;
                        if (isMobile) {
                            sidebarOpen = false;
                            sidebarCollapsed = false;
                        } else {
                            sidebarOpen = true;
                        }
                    }
                };
                window.addEventListener('resize', handleResize);
                
                // Eventos SPA
                if (spaEnabled) {
                    // Atualizar links ativos quando navegar
                    window.addEventListener('spa:navigated', (e) => {
                        const currentPath = e.detail.path;
                        const sidebarLinks = document.querySelectorAll('[data-spa-sidebar] a');
                        sidebarLinks.forEach(link => {
                            const linkPath = new URL(link.href).pathname;
                            if (linkPath === currentPath) {
                                link.classList.add('spa-active');
                            } else {
                                link.classList.remove('spa-active');
                            }
                        });
                    });
                    
                    // Marcar link ativo inicialmente
                    $nextTick(() => {
                        const currentPath = window.location.pathname;
                        const sidebarLinks = document.querySelectorAll('[data-spa-sidebar] a');
                        sidebarLinks.forEach(link => {
                            const linkPath = new URL(link.href).pathname;
                            if (linkPath === currentPath) {
                                link.classList.add('spa-active');
                            }
                        });
                    });
                }
            ">
            
            <!-- Mobile Overlay -->
            <div 
                x-show="isMobile && sidebarOpen"
                x-transition:enter="transition-opacity ease-linear duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition-opacity ease-linear duration-300"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                @click="sidebarOpen = false"
                class="fixed inset-0 bg-black/50 z-40 md:hidden"
            ></div>

            <!-- Sidebar -->
            <aside 
                :class="{ 
                    'translate-x-0': isMobile ? sidebarOpen : true,
                    '-translate-x-full': isMobile && !sidebarOpen,
                    '{{ sidebar_collapsed_width }}': !isMobile && sidebarCollapsed,
                    '{{ sidebar_width }}': !isMobile && !sidebarCollapsed || isMobile
                }"
                class="fixed inset-y-0 z-50 flex flex-col border-r bg-background transition-all duration-300 
                    {% if layout_type == 'sidebar-right' %}right-0 border-l border-r-0{% else %}left-0{% endif %}
                    md:relative md:translate-x-0 {{ sidebar_class|default:'' }}"
                {% if spa_enabled %}data-spa-sidebar{% endif %}
            >
                <!-- Sidebar Header -->
                <div class="flex {{ header_height }} items-center gap-3 border-b px-4 lg:px-6 py-4 flex-shrink-0">
                    <div x-show="!sidebarCollapsed || isMobile" class="flex items-center gap-3 flex-1">
                        <div class="size-8 rounded-radius-md bg-primary text-primary-foreground flex items-center justify-center font-bold">
                            <span x-show="sidebarCollapsed && !isMobile">C</span>
                            <span x-show="!sidebarCollapsed || isMobile">C</span>
                        </div>
                        <span class="font-semibold">Componentes</span>
                    </div>
                    
                    <!-- Toggle Buttons -->
                    <div class="flex items-center gap-2">
                        <!-- Desktop Collapse Button -->
                        {% if sidebar_collapsible %}
                            <button 
                                @click="sidebarCollapsed = !sidebarCollapsed"
                                class="hidden md:flex items-center justify-center size-8 rounded-radius-md hover:bg-accent transition-colors"
                                :class="{ 'ml-auto': sidebarCollapsed && !isMobile }"
                            >
                                <svg class="size-4" :class="{ 'rotate-180': sidebarCollapsed }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                                </svg>
                            </button>
                        {% endif %}
                        
                        <!-- Mobile Close Button -->
                        <button 
                            @click="sidebarOpen = false"
                            class="md:hidden flex items-center justify-center size-8 rounded-radius-md hover:bg-accent transition-colors"
                        >
                            <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Sidebar Content -->
                <div class="flex-1 overflow-y-auto p-4 lg:p-6">
                    {% if sidebar_content %}
                        {{ sidebar_content|safe }}
                    {% else %}
                        <!-- Default Sidebar Content -->
                        <nav class="space-y-2">
                            <a href="#" 
                               {% if spa_enabled %}data-spa-link{% endif %}
                               class="flex items-center gap-3 rounded-radius-md px-3 py-2 text-sm font-medium hover:bg-accent transition-colors">
                                <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v4H8V5z"/>
                                </svg>
                                <span x-show="!sidebarCollapsed || isMobile">Dashboard</span>
                            </a>
                            <a href="#" 
                               {% if spa_enabled %}data-spa-link{% endif %}
                               class="flex items-center gap-3 rounded-radius-md px-3 py-2 text-sm font-medium hover:bg-accent transition-colors">
                                <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                                </svg>
                                <span x-show="!sidebarCollapsed || isMobile">Usuários</span>
                            </a>
                            <a href="#" 
                               {% if spa_enabled %}data-spa-link{% endif %}
                               class="flex items-center gap-3 rounded-radius-md px-3 py-2 text-sm font-medium hover:bg-accent transition-colors">
                                <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span x-show="!sidebarCollapsed || isMobile">Configurações</span>
                            </a>
                        </nav>
                    {% endif %}
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col min-w-0">
                <!-- Header -->
                <header class="bg-background border-b border-border {{ header_height }} {{ header_class|default:'' }}"
                        {% if spa_enabled %}data-spa-header{% endif %}>
                    <div class="flex items-center h-full px-4 lg:px-6 py-4">
                        <!-- Mobile Menu Button -->
                        <button 
                            @click="sidebarOpen = !sidebarOpen"
                            class="md:hidden flex items-center justify-center size-8 rounded-radius-md hover:bg-accent transition-colors mr-4"
                        >
                            <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>

                        <!-- Header Content -->
                        <div class="flex-1 flex items-center justify-between">
                            {% if header_content %}
                                {{ header_content|safe }}
                            {% else %}
                                <!-- Default Header Content -->
                                <div class="flex items-center gap-4">
                                    <h1 class="text-xl font-semibold">Dashboard</h1>
                                </div>
                                <div class="flex items-center gap-4">
                                    <!-- SPA Loading Indicator -->
                                    {% if spa_enabled %}
                                        <div x-show="$store.spa.isLoading" class="spa-loading-spinner"></div>
                                    {% endif %}
                                    
                                    <button class="relative size-8 rounded-radius-md hover:bg-accent transition-colors flex items-center justify-center">
                                        <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5M4 19l5-5M13 7h5l-5-5M4 5l5 5"/>
                                        </svg>
                                    </button>
                                    <div class="size-8 rounded-radius-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-medium">
                                        U
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </header>

                <!-- Main Content -->
                <main class="flex-1 overflow-auto p-4 lg:p-6 {{ main_class|default:'' }}"
                      {% if spa_enabled %}id="spa-main-content"{% endif %}>
                    {% if main_content %}
                        {{ main_content|safe }}
                    {% else %}
                        <!-- Default Main Content -->
                        <div class="space-y-6">
                            
                        </div>
                    {% endif %}
                </main>

                <!-- Footer -->
                {% if footer_content or layout_type == "sidebar-left" or layout_type == "sidebar-right" %}
                    <footer class="bg-background border-t border-border {{ footer_height }} {{ footer_class|default:'' }}">
                        <div class="flex items-center justify-between h-full px-4 lg:px-6 py-4">
                            {% if footer_content %}
                                {{ footer_content|safe }}
                            {% else %}
                                <!-- Default Footer Content -->
                                <p class="text-sm text-muted-foreground">© 2024 Dashboard. Todos os direitos reservados.</p>
                                <div class="flex items-center gap-4">
                                    <a href="#" class="text-sm text-muted-foreground hover:text-foreground transition-colors">Privacidade</a>
                                    <a href="#" class="text-sm text-muted-foreground hover:text-foreground transition-colors">Termos</a>
                                    <a href="#" class="text-sm text-muted-foreground hover:text-foreground transition-colors">Suporte</a>
                                </div>
                            {% endif %}
                        </div>
                    </footer>
                {% endif %}
            </div>
        </div>

    {% elif layout_type == "sidebar-only" %}
        <!-- Layout apenas com Sidebar -->
        <div class="flex h-screen">
            <aside class="flex flex-col border-r bg-background {{ sidebar_width }} {{ sidebar_class|default:'' }}"
                   {% if spa_enabled %}data-spa-sidebar{% endif %}>
                <!-- Sidebar Header -->
                <div class="flex {{ header_height }} items-center gap-3 border-b px-4 lg:px-6 py-4">
                    <div class="size-8 rounded-radius-md bg-primary text-primary-foreground flex items-center justify-center font-bold">
                        L
                    </div>
                    <span class="font-semibold">Dashboard</span>
                </div>

                <!-- Sidebar Content -->
                <div class="flex-1 overflow-y-auto p-4 lg:p-6">
                    {% if sidebar_content %}
                        {{ sidebar_content|safe }}
                    {% else %}
                        <!-- Default Sidebar Content -->
                        <nav class="space-y-2">
                            <a href="#" 
                               {% if spa_enabled %}data-spa-link{% endif %}
                               class="flex items-center gap-3 rounded-radius-md px-3 py-2 text-sm font-medium hover:bg-accent transition-colors">
                                <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v4H8V5z"/>
                                </svg>
                                <span>Dashboard</span>
                            </a>
                        </nav>
                    {% endif %}
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-auto p-4 lg:p-6 {{ main_class|default:'' }}"
                  {% if spa_enabled %}id="spa-main-content"{% endif %}>
                {% if main_content %}
                    {{ main_content|safe }}
                {% else %}
                    <!-- Default Main Content -->
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold">Bem-vindo ao Dashboard</h2>
                        <p class="text-muted-foreground">Este é um layout apenas com sidebar.</p>
                    </div>
                {% endif %}
            </main>
        </div>

    {% elif layout_type == "header-only" %}
        <!-- Layout apenas com Header -->
        <div class="flex flex-col h-screen">
            <header class="bg-background border-b border-border {{ header_height }} {{ header_class|default:'' }}"
                    {% if spa_enabled %}data-spa-header{% endif %}>
                <div class="flex items-center justify-between h-full px-4 lg:px-6 py-4">
                    {% if header_content %}
                        {{ header_content|safe }}
                    {% else %}
                        <!-- Default Header Content -->
                        <div class="flex items-center gap-4">
                            <div class="size-8 rounded-radius-md bg-primary text-primary-foreground flex items-center justify-center font-bold">
                                L
                            </div>
                            <h1 class="text-xl font-semibold">Dashboard</h1>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- SPA Loading Indicator -->
                            {% if spa_enabled %}
                                <div x-show="$store.spa.isLoading" class="spa-loading-spinner"></div>
                            {% endif %}
                            
                            <button class="relative size-8 rounded-radius-md hover:bg-accent transition-colors flex items-center justify-center">
                                <svg class="size-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5M4 19l5-5M13 7h5l-5-5M4 5l5 5"/>
                                </svg>
                            </button>
                            <div class="size-8 rounded-radius-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-medium">
                                U
                            </div>
                        </div>
                    {% endif %}
                </div>
            </header>

            <main class="flex-1 overflow-auto p-4 lg:p-6 {{ main_class|default:'' }}"
                  {% if spa_enabled %}id="spa-main-content"{% endif %}>
                {% if main_content %}
                    {{ main_content|safe }}
                {% else %}
                    <!-- Default Main Content -->
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold">Bem-vindo ao Dashboard</h2>
                        <p class="text-muted-foreground">Este é um layout apenas com header.</p>
                    </div>
                {% endif %}
            </main>
        </div>

    {% else %}
        <!-- Layout Full (sem sidebar nem header) -->
        <main class="h-screen overflow-auto p-4 lg:p-6 {{ main_class|default:'' }}"
              {% if spa_enabled %}id="spa-main-content"{% endif %}>
            {% if main_content %}
                {{ main_content|safe }}
            {% else %}
                <!-- Default Main Content -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">Layout Full</h2>
                    <p class="text-muted-foreground">Este é um layout sem sidebar nem header.</p>
                </div>
            {% endif %}
        </main>
    {% endif %}
</div>

<!-- Include SPA Script -->
{% if spa_enabled %}
    <script src="{% static 'js/spa.js' %}"></script>
{% endif %} 